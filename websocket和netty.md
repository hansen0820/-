# 一、



## 1.1、什么时候用长连接，短连接？ 

长连接多用于操作频繁，点对点的通讯，而且连接数不能太多的情况。每个 TCP 连接都需要三步握手，这需要时间，如果每个操作都是先连接，再操作的话那么处理速度会降低很多， 所以每个操作完后都不断开，再次处理时直接发送数据包就OK 了，不用建立TCP连接。例如：数据库的连接用长连接，如果用短连接频繁的通信会造成socket错误，而且频繁的socket创建也是对资源的浪费。
而像WEB网站的http服务一般都用短连接，因为长连接对于服务端来说会耗费一定的资源，而像WEB网站这么频繁的成千上万甚至上亿客户端的连接用短连接会更省一些资源，如果用长连接，而且同时有成千上万的用户，如果每个用户都占用一个连接的话，那可想而知。所以并发量大，但每个用户无需频繁操作情况下用短连好。

## 1.2、TCP 状态转移

![image-20210730142443343](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210730142443343.png)

CLOSED：起始点，在超时或者连接关闭时候进入此状态。
LISTEN：svr 端在等待连接过来时候的状态，svr 端为此要调用 socket， bind,listen 函数，就能 进入此状态。此称为应用程序被动打开（等待客户端来连接）。 SYN_SENT：客户端发起连接，发送 SYN 给服务器端。如果服务器端不能连接，则直接进入 CLOSED 状态。 SYN_RCVD：跟 3 对应，服务器端接受客户端的 SYN 请求，服务器端由 LISTEN 状态进入 SYN_RCVD 状态。同时服务器端要回应一个 ACK，同时发送一个SYN 给客户端；另外一种情 况，客户端在发起 SYN 的同时接收到服务器端得 SYN 请求，客户端就会由 SYN_SENT 到 SYN_RCVD 状态。 
ESTABLISHED：服务器端和客户端在完成 3 次握手进入状态，说明已经可以开始传输数据了 以上是建立连接时服务器端和客户端产生的状态转移说明。相对来说比较简单明了， 如果你 对三次握手比较熟悉，建立连接时的状态转移还是很容易理解。 接下来服务器端和客户端就进行数据传输。。。。，当然，里面也大有学问，就此打住，稍 后再表。 下面，我们来看看连接关闭时候的状态转移说明，关闭需要进行 4 次双方的交互， 还包括要处 理一些善后工作（TIME_WAIT 状态），注意，这里主动关闭的一方或被动关闭的一方不是指 特指服务器端或者客户端，是相对于谁先发起关闭请求来说的： 
FIN_WAIT_1：主动关闭的一方，由状态 5 进入此状态。具体的动作时发送 FIN 给对方。 
FIN_WAIT_2：主动关闭的一方，接收到对方的 FIN ACK，进入此状态。由此不能再接收对方 的数据。但是能够向对方发送数据。 
CLOSE_WAIT：接收到 FIN 以后，被动关闭的一方进入此状态。具体动作时接收到FIN，同 时发送ACK。
LAST_ACK：被动关闭的一方，发起关闭请求，由状态 8 进入此状态。具体动作时发送FIN 给对方，同时在接收到 ACK 时进入CLOSED 状态。
CLOSING：两边同时发起关闭请求时，会由 FIN_WAIT_1 进入此状态。具体动作是， 接收 到 FIN 请求，同时响应一个 ACK。 
TIME_WAIT：最纠结的状态来了。从状态图上可以看出，有 3 个状态可以转化成它，我们 一 一来分析： 
由FIN_WAIT_2 进入此状态：在双方不同时发起 FIN 的情况下，主动关闭的一方在完成自身发 起的关闭请求后，接收到被动关闭一方的 FIN 后进入的状态。 
由CLOSING 状态进入：双方同时发起关闭，都做了发起 FIN 的请求，同时接收到了FIN 并做了 ACK 的情况下，由 CLOSING 状态进入。 
由FIN_WAIT_1 状态进入：同时接受到 FIN（对方发起），ACK（本身发起的 FIN 回应），与 b 的区别在于本身发起的 FIN 回应的ACK 先于对方的 FIN 请求到达，而 b 是 FIN 先到达。这种情况概率最小。

## 1.3、什么是WebSocket

WebSocket 是一种计算机通信协议，通过单个 TCP 连接提供全双工通信信道。

![image-20210730145324407](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210730145324407.png)

1、WebSocket是双向的-使用WebSocket客户端或服务器可以发起消息发送。
2、WebSocket是全双工的-客户端和服务器通信是相互独立的。
3、单个TCP连接-初始连接使用HTTP，然后将此连接升级到基于套接字的连接。
然后这个单一连接用于所有未来的通信
4、Light与http 相比，WebSocket消息数据交换要轻得多
